services:
  # monitoring
  smokeping:
    image: lscr.io/linuxserver/smokeping
    container_name: smokeping
    volumes:
      - "{{ appdata_path }}/apps/smokeping/config:/config"
      - "{{ appdata_path }}/apps/smokeping/data:/data"
    labels:
      - traefik.enable=true
      - "traefik.http.routers.smokeping.rule=Host(`smokeping.{{ norbert_domain_me }}`)"
    environment:
      - PUID=1000
      - PGID=1000
      - "TZ={{ host_timezone }}"
    dns:
      - 1.1.1.1
    hostname: norbert
    restart: unless-stopped
  librespeed:
    image: lscr.io/linuxserver/librespeed
    container_name: librespeed
    labels:
      - traefik.enable=false
    ports:
      - 8008:80
    environment:
      - MODE=standalone
    restart: unless-stopped
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - "{{ appdata_path }}/apps/prometheus/data:/prometheus/data"
      - "{{ appdata_path }}/apps/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus/data
      - --storage.tsdb.retention.time=15d
    user: "{{ docker_compose_generator_uid }}:{{ docker_compose_generator_gid }}"
    restart: unless-stopped
  nut-exporter:
    image: ghcr.io/druggeri/nut_exporter:latest
    container_name: nut-exporter
    command:
      - --nut.server=host.docker.internal
      - --nut.serverport=3493
      - --nut.username={{ nut_monitor_username }}
      - --nut.vars_enable=battery.charge,battery.runtime,battery.voltage,battery.voltage.nominal,input.voltage,input.voltage.nominal,output.voltage,output.voltage.nominal,ups.load,ups.realpower,ups.status
    environment:
      - "NUT_EXPORTER_PASSWORD={{ nut_monitor_password }}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
  unpoller:
    image: ghcr.io/unpoller/unpoller:latest
    container_name: unpoller
    environment:
      - "UP_UNIFI_DEFAULT_URL={{ unifi_nor_controller_url }}"
      - "UP_UNIFI_DEFAULT_USER={{ unifi_nor_controller_username }}"
      - "UP_UNIFI_DEFAULT_PASS={{ unifi_nor_controller_password }}"
      - "UP_UNIFI_DEFAULT_SITE={{ unifi_nor_controller_site }}"
      - "UP_UNIFI_DEFAULT_VERIFY_SSL={{ unifi_nor_controller_verify_ssl }}"
      - "UP_INFLUXDB_DISABLE=true"
    restart: unless-stopped
  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    volumes:
      - "{{ appdata_path }}/apps/grafana/data:/var/lib/grafana"
      - "{{ appdata_path }}/apps/grafana/datasources:/etc/grafana/provisioning/datasources:ro"
      - "{{ appdata_path }}/apps/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro"
    labels:
      - traefik.enable=true
      - "traefik.http.routers.grafana.rule=Host(`grafana.{{ norbert_domain_me }}`)"
    environment:
      - GF_SERVER_DOMAIN=grafana.{{ norbert_domain_me }}
      - GF_SERVER_ROOT_URL=https://grafana.{{ norbert_domain_me }}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Tailscale
      - "GF_AUTH_GENERIC_OAUTH_CLIENT_ID={{ grafana_oidc_client_id }}"
      - "GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET={{ grafana_oidc_client_secret }}"
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://idp.ktz.ts.net/authorize
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://idp.ktz.ts.net/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://idp.ktz.ts.net/userinfo
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Editor
      - "GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}"
    user: "{{ docker_compose_generator_uid }}:{{ docker_compose_generator_gid }}"
    restart: unless-stopped
